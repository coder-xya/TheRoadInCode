# 配置文件详解

> 逐行解释项目中的每一个配置文件

## 1. 根目录配置文件

### 1.1 package.json（根）

**官方文档**：[npm package.json](https://docs.npmjs.com/cli/v10/configuring-npm/package-json)

```json
{
  "name": "the-road-in-code",
  // 项目名称，kebab-case 格式

  "version": "0.0.1",
  // 语义化版本：主版本.次版本.修订版本

  "private": true,
  // 私有项目，防止意外发布到 npm

  "description": "现代化个人博客系统 - 技术分享、作品展示、实验平台",
  // 项目描述

  "author": "TDY0903",
  // 作者信息

  "license": "MIT",
  // 开源许可证

  "scripts": {
    "dev": "turbo dev",
    // 启动所有应用的开发服务器
    // 实际执行：并行运行 apps/web 和 apps/api 的 dev 脚本

    "build": "turbo build",
    // 构建所有应用
    // Turborepo 会根据依赖关系确定构建顺序

    "lint": "turbo lint",
    // 对所有包运行 ESLint 检查

    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\"",
    // 格式化所有代码文件

    "format:check": "prettier --check \"**/*.{ts,tsx,js,jsx,json,md}\"",
    // 检查格式（不修改）

    "test": "turbo test",
    // 运行所有测试

    "clean": "turbo clean && rm -rf node_modules",
    // 清理所有构建产物和依赖

    "prepare": "husky"
    // 安装 Git hooks（npm install 后自动执行）
  },

  "devDependencies": {
    "@types/node": "^20.11.0",
    // Node.js 类型定义

    "husky": "^9.0.0",
    // Git hooks 管理工具

    "lint-staged": "^15.2.0",
    // 只检查暂存区的文件

    "prettier": "^3.2.0",
    // 代码格式化工具

    "turbo": "^2.3.0",
    // Turborepo 构建系统

    "typescript": "^5.3.0"
    // TypeScript 编译器
  },

  "packageManager": "pnpm@9.15.0",
  // 指定包管理器版本（Corepack 使用）

  "engines": {
    "node": ">=20.0.0",
    "pnpm": ">=9.0.0"
  }
  // 要求的运行时版本
}
```

### 1.2 pnpm-workspace.yaml

**官方文档**：[pnpm Workspaces](https://pnpm.io/workspaces)

```yaml
packages:
  - "apps/*"
  # 匹配 apps 目录下的所有子目录
  # 包括：apps/web, apps/api

  - "packages/*"
  # 匹配 packages 目录下的所有子目录
  # 包括：packages/database, packages/shared, etc.
```

**工作原理**：
1. pnpm 扫描这些目录下的 `package.json`
2. 识别出所有工作区包
3. 建立包之间的依赖关系
4. 使用符号链接共享依赖

### 1.3 turbo.json

**官方文档**：[Turborepo Configuration](https://turbo.build/repo/docs/reference/configuration)

```json
{
  "$schema": "https://turbo.build/schema.json",
  // JSON Schema，提供编辑器自动补全

  "ui": "tui",
  // 使用终端 UI 模式（Terminal User Interface）
  // 可选值："tui" | "stream"

  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      // ^build 表示：先构建所有依赖包
      // 例如：apps/web 依赖 @repo/shared，先构建 shared

      "inputs": ["$TURBO_DEFAULT$", ".env*"],
      // 影响缓存的输入文件
      // $TURBO_DEFAULT$：源代码、package.json 等
      // .env*：环境变量文件

      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
      // 构建输出目录
      // .next/**：Next.js 产物
      // !.next/cache/**：排除缓存目录
      // dist/**：NestJS 产物
    },

    "dev": {
      "cache": false,
      // 开发模式不缓存

      "persistent": true
      // 持久运行（不会自动退出）
    },

    "lint": {
      "dependsOn": ["^build"],
      // 先构建依赖，确保类型可用

      "cache": true
      // 缓存 lint 结果
    },

    "test": {
      "dependsOn": ["^build"],
      "cache": true
    },

    "clean": {
      "cache": false
      // 清理任务不缓存
    }
  }
}
```

### 1.4 .prettierrc

**官方文档**：[Prettier Options](https://prettier.io/docs/en/options.html)

```json
{
  "semi": true,
  // 语句末尾加分号
  // true:  const a = 1;
  // false: const a = 1

  "singleQuote": true,
  // 使用单引号
  // true:  'hello'
  // false: "hello"

  "tabWidth": 2,
  // 缩进宽度：2 个空格

  "trailingComma": "es5",
  // 尾逗号策略
  // "es5":  对象/数组末尾加逗号
  // "none": 不加
  // "all":  函数参数也加

  "printWidth": 100,
  // 每行最大字符数

  "bracketSpacing": true,
  // 对象括号内加空格
  // true:  { foo: bar }
  // false: {foo: bar}

  "arrowParens": "always",
  // 箭头函数参数括号
  // "always": (x) => x
  // "avoid":  x => x

  "endOfLine": "lf"
  // 换行符：LF（Unix 风格）
}
```

### 1.5 .lintstagedrc.js

**官方文档**：[lint-staged](https://github.com/lint-staged/lint-staged)

```javascript
module.exports = {
  // TypeScript/JavaScript 文件
  '*.{ts,tsx}': ['eslint --fix', 'prettier --write'],
  // 1. ESLint 自动修复
  // 2. Prettier 格式化

  // JavaScript 文件
  '*.{js,jsx}': ['eslint --fix', 'prettier --write'],

  // 其他文件（只格式化）
  '*.{json,md,yaml,yml}': ['prettier --write'],

  // CSS 文件
  '*.css': ['prettier --write'],
};
```

### 1.6 .gitignore

```gitignore
# 依赖目录
node_modules/

# 构建产物
dist/
.next/
.turbo/

# 环境变量（包含敏感信息）
.env
.env.local
.env.*.local

# 编辑器配置
.vscode/
.idea/

# 操作系统文件
.DS_Store
Thumbs.db

# 日志文件
*.log
npm-debug.log*

# 测试覆盖率
coverage/
```

---

## 2. Next.js 配置（apps/web）

### 2.1 next.config.ts

**官方文档**：[next.config.js Options](https://nextjs.org/docs/app/api-reference/next-config-js)

```typescript
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  reactStrictMode: true,
  // 启用 React 严格模式
  // 开发时会渲染两次以检测副作用问题
  // 官方文档：https://react.dev/reference/react/StrictMode

  transpilePackages: ['@repo/shared'],
  // 转译指定的 node_modules 包
  // Monorepo 中的内部包需要被转译
  // 官方文档：https://nextjs.org/docs/app/api-reference/next-config-js/transpilePackages
};

export default nextConfig;
```

**常用配置项**：

```typescript
const nextConfig: NextConfig = {
  // 图片优化配置
  images: {
    domains: ['example.com'],  // 允许的图片域名
    // 官方文档：https://nextjs.org/docs/app/api-reference/components/image
  },

  // 重定向规则
  async redirects() {
    return [
      {
        source: '/old-path',
        destination: '/new-path',
        permanent: true,  // 301 重定向
      },
    ];
  },

  // 重写规则（URL 不变，内容变）
  async rewrites() {
    return [
      {
        source: '/api/v1/:path*',
        destination: 'http://localhost:4000/api/v1/:path*',  // 代理到后端
      },
    ];
  },
};
```

**环境变量的推荐方式**：
- 在 `apps/web/.env.local` 里配置（可以参考 `.env.example`）
- 只有 `NEXT_PUBLIC_` 前缀的变量会暴露到浏览器，其它变量只在服务端可用

### 2.2 tailwind.config.ts

**官方文档**：[Tailwind Configuration](https://tailwindcss.com/docs/configuration)

```typescript
import type { Config } from 'tailwindcss';

const config: Config = {
  darkMode: 'class',
  // 暗黑模式策略
  // 'class': 通过 <html class="dark"> 控制
  // 'media': 跟随系统设置
  // 官方文档：https://tailwindcss.com/docs/dark-mode

  content: [
    './src/**/*.{js,ts,jsx,tsx,mdx}',
    './app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  // 扫描这些文件查找类名
  // Tailwind 只生成实际使用的 CSS
  // 官方文档：https://tailwindcss.com/docs/content-configuration

  theme: {
    extend: {
      // 扩展默认主题（不覆盖）
      fontFamily: {
        sans: ['var(--font-geist-sans)'],
        mono: ['var(--font-geist-mono)'],
      },
      // 自定义字体
      // 官方文档：https://tailwindcss.com/docs/font-family

      // 可以添加更多扩展：
      // colors: { brand: '#1e40af' },
      // spacing: { '128': '32rem' },
      // borderRadius: { '4xl': '2rem' },
    },
  },

  plugins: [],
  // 官方插件：
  // require('@tailwindcss/typography')  // 文章排版
  // require('@tailwindcss/forms')       // 表单样式
  // require('@tailwindcss/aspect-ratio') // 宽高比
};

export default config;
```

### 2.3 postcss.config.mjs

**官方文档**：[PostCSS](https://postcss.org/)

```javascript
export default {
  plugins: {
    tailwindcss: {},
    // 处理 Tailwind 指令（@tailwind, @apply）

    autoprefixer: {},
    // 自动添加浏览器前缀
    // 例如：-webkit-transform, -moz-transform
  },
};
```

### 2.4 tsconfig.json（Next.js）

**官方文档**：[TypeScript in Next.js](https://nextjs.org/docs/app/building-your-application/configuring/typescript)

```json
{
  "extends": "@repo/typescript-config/nextjs.json",
  // 继承共享的 Next.js TypeScript 配置

  "compilerOptions": {
    "baseUrl": ".",
    // 模块解析的基础目录

    "paths": {
      "@/*": ["./src/*"]
    }
    // 路径别名
    // import { Button } from '@/components/Button'
    // 等价于 import { Button } from './src/components/Button'
  },

  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  // 包含的文件

  "exclude": ["node_modules"]
  // 排除的文件
}
```

---

## 3. NestJS 配置（apps/api）

### 3.1 nest-cli.json

**官方文档**：[Nest CLI](https://docs.nestjs.com/cli/overview)

```json
{
  "$schema": "https://json.schemastore.org/nest-cli",
  // JSON Schema

  "collection": "@nestjs/schematics",
  // 代码生成器集合
  // 使用 nest generate 命令时使用

  "sourceRoot": "src",
  // 源代码根目录

  "compilerOptions": {
    "deleteOutDir": true
    // 编译前删除输出目录
    // 确保没有旧文件残留
  }
}
```

**常用 CLI 命令**：

```bash
# 生成模块
nest generate module users
# 创建 src/users/users.module.ts

# 生成控制器
nest generate controller users
# 创建 src/users/users.controller.ts

# 生成服务
nest generate service users
# 创建 src/users/users.service.ts

# 生成完整资源（CRUD）
nest generate resource posts
# 创建完整的 posts 模块、控制器、服务、DTO
```

### 3.2 tsconfig.json（NestJS）

```json
{
  "extends": "@repo/typescript-config/nestjs.json",
  // 继承共享的 NestJS TypeScript 配置

  "compilerOptions": {
    "outDir": "./dist",
    // 输出目录

    "baseUrl": "./",
    "paths": {
      "@/*": ["src/*"]
    }
    // 路径别名
  },

  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "test"]
}
```

### 3.3 .env.example（API）

```bash
# 数据库连接
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/roadincode"
# 格式：postgresql://用户:密码@主机:端口/数据库名

# JWT 配置
JWT_SECRET="your-super-secret-key-change-in-production"
JWT_EXPIRES_IN="7d"
# 过期时间：7d（7天）、1h（1小时）、30m（30分钟）

# 服务器配置
PORT=4000
NODE_ENV=development

# Redis（可选）
REDIS_URL="redis://localhost:6379"

# OAuth（可选）
GITHUB_CLIENT_ID=""
GITHUB_CLIENT_SECRET=""
GOOGLE_CLIENT_ID=""
GOOGLE_CLIENT_SECRET=""
```

---

## 4. TypeScript 共享配置（packages/typescript-config）

### 4.1 base.json

**官方文档**：[TSConfig Reference](https://www.typescriptlang.org/tsconfig)

```json
{
  "$schema": "https://json.schemastore.org/tsconfig",

  "compilerOptions": {
    "strict": true,
    // 启用所有严格类型检查
    // 包括：strictNullChecks, strictFunctionTypes, etc.

    "strictNullChecks": true,
    // null 和 undefined 检查
    // 防止 "Cannot read property of undefined" 错误

    "esModuleInterop": true,
    // 允许 import React from 'react' 语法
    // 而不是 import * as React from 'react'

    "skipLibCheck": true,
    // 跳过 .d.ts 文件的类型检查
    // 加快编译速度

    "forceConsistentCasingInFileNames": true,
    // 强制文件名大小写一致
    // 防止 Windows/Mac 与 Linux 的差异问题

    "moduleResolution": "bundler",
    // 模块解析策略
    // "bundler": 适用于 Vite, esbuild 等现代打包工具
    // "node": 传统 Node.js 解析

    "resolveJsonModule": true,
    // 允许导入 JSON 文件
    // import data from './data.json'

    "isolatedModules": true,
    // 确保每个文件可以独立编译
    // 某些构建工具（如 esbuild）需要此选项

    "noEmit": true,
    // 不输出编译结果
    // 仅做类型检查

    "declaration": true,
    // 生成 .d.ts 类型声明文件

    "declarationMap": true,
    // 生成声明文件的 source map

    "incremental": true
    // 增量编译
    // 只重新编译修改的文件
  }
}
```

### 4.2 nextjs.json

```json
{
  "extends": "./base.json",
  // 继承基础配置

  "compilerOptions": {
    "target": "ES2017",
    // 编译目标 JavaScript 版本

    "lib": ["dom", "dom.iterable", "esnext"],
    // 包含的类型库
    // dom: 浏览器 DOM API
    // esnext: 最新 ECMAScript 特性

    "jsx": "preserve",
    // JSX 处理方式
    // preserve: 保留 JSX，让 Next.js 处理

    "module": "esnext",
    // 模块系统：ESM

    "allowJs": true,
    // 允许编译 JavaScript 文件

    "noEmit": true,
    // Next.js 负责编译，TS 只做类型检查

    "plugins": [
      { "name": "next" }
    ]
    // Next.js 类型插件
  }
}
```

### 4.3 nestjs.json

```json
{
  "extends": "./base.json",

  "compilerOptions": {
    "target": "ES2021",
    // Node.js 20 支持 ES2021

    "module": "commonjs",
    // NestJS 使用 CommonJS

    "declaration": true,
    "removeComments": true,
    // 移除注释

    "emitDecoratorMetadata": true,
    // 生成装饰器元数据
    // NestJS 依赖注入需要此选项

    "experimentalDecorators": true,
    // 启用装饰器语法
    // @Controller(), @Injectable() 等

    "sourceMap": true,
    // 生成 source map（调试用）

    "outDir": "./dist",
    "noEmit": false
    // NestJS 需要输出编译结果
  }
}
```

### 4.4 library.json

```json
{
  "extends": "./base.json",

  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "declaration": true,
    "declarationMap": true,
    "outDir": "./dist",
    "noEmit": false
  }
}
```

---

## 5. ESLint 共享配置（packages/eslint-config）

### 5.1 base.js

**官方文档**：[ESLint Configuration](https://eslint.org/docs/latest/use/configure/)

```javascript
/** @type {import("eslint").Linter.Config} */
module.exports = {
  parser: '@typescript-eslint/parser',
  // TypeScript 解析器
  // 官方：https://typescript-eslint.io/packages/parser

  plugins: ['@typescript-eslint', 'import'],
  // 插件列表
  // @typescript-eslint: TypeScript 规则
  // import: 导入/导出规则

  extends: [
    'eslint:recommended',
    // ESLint 推荐规则
    // https://eslint.org/docs/latest/rules/

    'plugin:@typescript-eslint/recommended',
    // TypeScript 推荐规则
    // https://typescript-eslint.io/rules/

    'prettier',
    // 关闭与 Prettier 冲突的规则
    // 必须放在最后！
  ],

  env: {
    node: true,      // Node.js 全局变量
    es2022: true,    // ES2022 语法
  },

  rules: {
    '@typescript-eslint/no-unused-vars': ['warn', { argsIgnorePattern: '^_' }],
    // 未使用变量：警告
    // 但忽略以 _ 开头的参数（如 _req）

    '@typescript-eslint/no-explicit-any': 'warn',
    // 显式 any 类型：警告

    '@typescript-eslint/explicit-function-return-type': 'off',
    // 函数返回类型：关闭（让 TS 推断）

    'import/order': [
      'warn',
      {
        groups: ['builtin', 'external', 'internal', 'parent', 'sibling', 'index'],
        // 导入分组顺序：
        // builtin: Node.js 内置（path, fs）
        // external: node_modules
        // internal: 项目内部包（@repo/*）
        // parent: 父目录（../*）
        // sibling: 同级目录（./*）
        // index: index 文件

        'newlines-between': 'always',
        // 组之间空行

        alphabetize: { order: 'asc' },
        // 组内按字母排序
      },
    ],
  },

  ignorePatterns: ['node_modules/', 'dist/', '.next/', '.turbo/'],
  // 忽略的目录
};
```

### 5.2 nextjs.js

```javascript
module.exports = {
  extends: [
    'next/core-web-vitals',
    // Next.js 规则 + Core Web Vitals
    // https://nextjs.org/docs/app/building-your-application/configuring/eslint

    './base.js',
    // 继承基础配置
  ],

  rules: {
    '@next/next/no-html-link-for-pages': 'off',
    // 允许使用 <a> 标签（在某些场景需要）

    'react/jsx-key': 'warn',
    // 列表渲染需要 key
  },
};
```

### 5.3 nestjs.js

```javascript
module.exports = {
  extends: ['./base.js'],

  rules: {
    '@typescript-eslint/interface-name-prefix': 'off',
    '@typescript-eslint/explicit-module-boundary-types': 'off',
    // NestJS 装饰器会处理类型
  },
};
```

---

## 6. Prisma 配置（packages/database）

### 6.1 prisma/schema.prisma

**官方文档**：[Prisma Schema](https://www.prisma.io/docs/concepts/components/prisma-schema)

```prisma
// ==================== 生成器配置 ====================
generator client {
  provider = "prisma-client-js"
  // 生成 JavaScript/TypeScript 客户端
  // 官方文档：https://www.prisma.io/docs/concepts/components/prisma-client
}

// ==================== 数据源配置 ====================
datasource db {
  provider = "postgresql"
  // 数据库类型：postgresql, mysql, sqlite, sqlserver, mongodb
  // 官方文档：https://www.prisma.io/docs/concepts/database-connectors

  url = env("DATABASE_URL")
  // 从环境变量读取连接字符串
}

// ==================== 枚举类型 ====================
enum UserRole {
  USER
  ADMIN
}
// 官方文档：https://www.prisma.io/docs/concepts/components/prisma-schema/data-model#defining-enums

// ==================== 数据模型 ====================
model User {
  id           String         @id @default(cuid())
  // @id: 主键
  // @default(cuid()): 自动生成 CUID
  // 其他选项：uuid(), autoincrement()

  email        String         @unique
  // @unique: 唯一约束

  username     String         @unique

  passwordHash String?
  // ?: 可选字段（允许 null）

  role         UserRole       @default(USER)
  // @default(): 默认值

  avatar       String?
  bio          String?

  // ==================== 关系字段 ====================
  oauth        OAuthAccount[]
  // 一对多：一个用户有多个 OAuth 账号

  posts        Post[]
  // 一对多：一个用户有多篇文章

  comments     Comment[]

  // ==================== 时间戳 ====================
  createdAt    DateTime       @default(now())
  // @default(now()): 创建时自动设置当前时间

  updatedAt    DateTime       @updatedAt
  // @updatedAt: 更新时自动更新时间
}

model Post {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  content     String
  summary     String?
  coverImage  String?
  published   Boolean   @default(false)
  featured    Boolean   @default(false)
  views       Int       @default(0)

  // ==================== 关系定义 ====================
  author      User      @relation(fields: [authorId], references: [id])
  // @relation: 定义关系
  // fields: 本表的外键字段
  // references: 关联表的主键

  authorId    String
  // 外键字段

  category    Category? @relation(fields: [categoryId], references: [id])
  categoryId  String?

  tags        PostTag[]
  // 多对多关系（通过中间表）

  comments    Comment[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // ==================== 索引 ====================
  @@index([published, createdAt(sort: Desc)])
  // 复合索引：加速 "查询已发布文章按时间排序"
  // 官方文档：https://www.prisma.io/docs/concepts/components/prisma-schema/indexes

  @@index([slug])
  // 单字段索引
}

// ==================== 多对多中间表 ====================
model PostTag {
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  // onDelete: Cascade - 删除文章时自动删除关联

  postId String

  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId  String

  @@id([postId, tagId])
  // 复合主键
}
```

---

## 7. Docker 配置（docker/）

### 7.1 docker-compose.yml（开发环境）

**官方文档**：[Docker Compose](https://docs.docker.com/compose/compose-file/)

```yaml
version: '3.8'
# Compose 文件版本

services:
  # ==================== PostgreSQL 数据库 ====================
  db:
    image: postgres:16-alpine
    # 使用 Alpine 版本（更小）
    # 官方镜像：https://hub.docker.com/_/postgres

    container_name: roadincode-db
    # 容器名称（方便 docker exec）

    restart: unless-stopped
    # 重启策略
    # no: 不重启
    # always: 总是重启
    # on-failure: 失败时重启
    # unless-stopped: 除非手动停止

    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: roadincode
    # 环境变量
    # 官方文档：https://hub.docker.com/_/postgres#environment-variables

    ports:
      - '5432:5432'
    # 端口映射：主机端口:容器端口

    volumes:
      - postgres_data:/var/lib/postgresql/data
    # 数据持久化
    # postgres_data: 命名卷
    # /var/lib/postgresql/data: PostgreSQL 数据目录

    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s    # 检查间隔
      timeout: 5s      # 超时时间
      retries: 5       # 重试次数
    # 健康检查
    # 官方文档：https://docs.docker.com/compose/compose-file/#healthcheck

  # ==================== Redis 缓存 ====================
  redis:
    image: redis:7-alpine
    container_name: roadincode-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

# ==================== 数据卷定义 ====================
volumes:
  postgres_data:
    # 持久化 PostgreSQL 数据
  redis_data:
    # 持久化 Redis 数据
```

### 7.2 api.Dockerfile（生产环境）

**官方文档**：[Dockerfile Reference](https://docs.docker.com/reference/dockerfile/)

```dockerfile
# ==================== 构建阶段 ====================
FROM node:20-alpine AS builder
# 基础镜像：Node.js 20 Alpine 版
# AS builder: 命名此阶段

WORKDIR /app
# 设置工作目录

# 启用 pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate
# Corepack 是 Node.js 内置的包管理器管理工具

# 先复制依赖文件（利用 Docker 缓存）
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml* ./
COPY apps/api/package.json ./apps/api/
COPY packages/typescript-config/package.json ./packages/typescript-config/
COPY packages/database/package.json ./packages/database/
COPY packages/shared/package.json ./packages/shared/

# 安装依赖
RUN pnpm install --frozen-lockfile
# --frozen-lockfile: 严格按 lock 文件安装

# 复制源代码
COPY packages/typescript-config ./packages/typescript-config
COPY packages/database ./packages/database
COPY packages/shared ./packages/shared
COPY apps/api ./apps/api

# 生成 Prisma Client
RUN pnpm --filter @repo/database db:generate

# 构建
RUN pnpm --filter @repo/shared build
RUN pnpm --filter @repo/database build
RUN pnpm --filter api build

# ==================== 生产阶段 ====================
FROM node:20-alpine AS runner
# 新的干净阶段

WORKDIR /app

ENV NODE_ENV=production

# 创建非 root 用户（安全最佳实践）
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nestjs

# 只复制运行需要的文件
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/apps/api/dist ./dist
COPY --from=builder /app/apps/api/node_modules ./apps/api/node_modules
COPY --from=builder /app/packages/database/node_modules/.prisma ./node_modules/.prisma
# --from=builder: 从 builder 阶段复制

# 使用非 root 用户
USER nestjs

EXPOSE 4000

ENV PORT=4000

CMD ["node", "dist/main.js"]
```

---

## 8. 总结

### 配置文件速查表

| 文件 | 职责 | 修改频率 |
|------|------|----------|
| `package.json` | 依赖和脚本 | 中 |
| `pnpm-workspace.yaml` | 工作区范围 | 低 |
| `turbo.json` | 构建任务 | 低 |
| `.prettierrc` | 代码格式 | 低 |
| `tsconfig.json` | TypeScript 配置 | 低 |
| `next.config.ts` | Next.js 配置 | 中 |
| `tailwind.config.ts` | 样式主题 | 中 |
| `schema.prisma` | 数据模型 | 高 |
| `docker-compose.yml` | 容器配置 | 低 |

### 修改配置的注意事项

1. **修改共享配置后**：所有依赖包需要重新检查
2. **修改 Prisma Schema 后**：运行 `pnpm --filter @repo/database db:push`
3. **修改 TypeScript 配置后**：可能需要重启 IDE
4. **修改 Docker 配置后**：运行 `docker compose up -d --build`

**一句话总结**：配置文件是项目的骨架，理解它们就理解了项目的运作方式。
