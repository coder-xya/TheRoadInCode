# Turborepo è¯¦è§£

> é¢å‘åˆçº§å¼€å‘è€…çš„ Turborepo æ•™ç¨‹ï¼Œéµå¾ªäºŒå…«åŸåˆ™

## å®˜æ–¹èµ„æº

| èµ„æº | é“¾æ¥ |
|------|------|
| å®˜æ–¹æ–‡æ¡£ | [turbo.build/repo/docs](https://turbo.build/repo/docs) |
| é…ç½®å‚è€ƒ | [turbo.build/repo/docs/reference/configuration](https://turbo.build/repo/docs/reference/configuration) |
| CLI å‘½ä»¤ | [turbo.build/repo/docs/reference/command-line-reference](https://turbo.build/repo/docs/reference/command-line-reference) |
| GitHub | [github.com/vercel/turbo](https://github.com/vercel/turbo) |
| ç¤ºä¾‹é¡¹ç›® | [github.com/vercel/turbo/tree/main/examples](https://github.com/vercel/turbo/tree/main/examples) |

## 1. Turborepo æ˜¯ä»€ä¹ˆ

### ä¸€å¥è¯è§£é‡Š
Turborepo æ˜¯ä¸€ä¸ª**é«˜æ€§èƒ½çš„ Monorepo æ„å»ºç³»ç»Ÿ**ï¼Œèƒ½è®©ä½ çš„æ„å»ºé€Ÿåº¦æå‡ 10 å€ä»¥ä¸Šã€‚

### ç±»æ¯”ç†è§£
æƒ³è±¡ä½ åœ¨åšé¥­ï¼š
- **æ²¡æœ‰ Turborepo**ï¼šæ¯æ¬¡åšé¥­éƒ½ä»ä¹°èœå¼€å§‹ï¼Œå³ä½¿å†°ç®±é‡Œæœ‰ç°æˆçš„
- **æœ‰ Turborepo**ï¼šè®°ä½å“ªäº›èœå·²ç»å‡†å¤‡å¥½äº†ï¼Œåªåšéœ€è¦æ›´æ–°çš„éƒ¨åˆ†

### æ ¸å¿ƒä»·å€¼
| é—®é¢˜ | Turborepo è§£å†³æ–¹æ¡ˆ |
|------|-------------------|
| æ„å»ºå¤ªæ…¢ | æ™ºèƒ½ç¼“å­˜ï¼Œè·³è¿‡æœªå˜æ›´çš„åŒ… |
| ä»»åŠ¡é‡å¤æ‰§è¡Œ | è®°ä½ä¸Šæ¬¡ç»“æœï¼Œç›´æ¥å¤ç”¨ |
| ä¾èµ–é¡ºåºæ··ä¹± | è‡ªåŠ¨åˆ†æä¾èµ–ï¼Œå¹¶è¡Œæ‰§è¡Œ |
| CI æ—¶é—´é•¿ | è¿œç¨‹ç¼“å­˜ï¼Œå›¢é˜Ÿå…±äº«æ„å»ºç»“æœ |

---

## 2. æ ¸å¿ƒæ¦‚å¿µï¼ˆ20% æ ¸å¿ƒçŸ¥è¯†ï¼‰

### 2.1 Taskï¼ˆä»»åŠ¡ï¼‰

ä»»åŠ¡å°±æ˜¯ package.json ä¸­çš„ scriptsï¼š

```json
{
  "scripts": {
    "build": "tsc",
    "dev": "next dev",
    "lint": "eslint .",
    "test": "jest"
  }
}
```

Turborepo å¯ä»¥æ™ºèƒ½åœ°è¿è¡Œè¿™äº›ä»»åŠ¡ã€‚

### 2.2 Pipelineï¼ˆç®¡é“ï¼‰

åœ¨ `turbo.json` ä¸­å®šä¹‰ä»»åŠ¡ä¹‹é—´çš„å…³ç³»ï¼š

```json
{
  "tasks": {
    "build": {
      "dependsOn": ["^build"]  // å…ˆæ„å»ºä¾èµ–çš„åŒ…
    }
  }
}
```

### 2.3 ç¼“å­˜ï¼ˆCacheï¼‰

Turborepo çš„æ€æ‰‹é”ï¼š

```
ç¬¬ä¸€æ¬¡è¿è¡Œ pnpm buildï¼š
  [1/3] @repo/shared: build (2.3s)
  [2/3] web: build (15.2s)
  [3/3] api: build (8.1s)
  æ€»è®¡: 25.6s

ç¬¬äºŒæ¬¡è¿è¡Œï¼ˆæ— æ”¹åŠ¨ï¼‰ï¼š
  [1/3] @repo/shared: build (cache hit) âœ“
  [2/3] web: build (cache hit) âœ“
  [3/3] api: build (cache hit) âœ“
  æ€»è®¡: 0.3s  âš¡ å¿«äº† 85 å€ï¼
```

### 2.4 ä¾èµ–å›¾ï¼ˆDependency Graphï¼‰

Turborepo è‡ªåŠ¨åˆ†æåŒ…ä¹‹é—´çš„ä¾èµ–ï¼š

```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   shared    â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     web     â”‚     â”‚     api     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ„å»ºæ—¶ä¼šå…ˆæ„å»º `shared`ï¼Œç„¶åå¹¶è¡Œæ„å»º `web` å’Œ `api`ã€‚

---

## 3. é¡¹ç›®é…ç½®æ–‡ä»¶è¯¦è§£

### 3.1 turbo.jsonï¼ˆé€è¡Œè§£é‡Šï¼‰

```json
{
  "$schema": "https://turbo.build/schema.json",
  // ä½œç”¨ï¼šæä¾› JSON è‡ªåŠ¨è¡¥å…¨å’ŒéªŒè¯

  "ui": "tui",
  // ä½œç”¨ï¼šä½¿ç”¨ç»ˆç«¯ UI æ˜¾ç¤ºæ„å»ºè¿›åº¦ï¼ˆæ›´ç¾è§‚ï¼‰

  "tasks": {
    // å®šä¹‰å¯ä»¥è¿è¡Œçš„ä»»åŠ¡

    "build": {
      "dependsOn": ["^build"],
      // ^build è¡¨ç¤ºï¼šå…ˆæ„å»ºæ‰€æœ‰ä¾èµ–çš„åŒ…
      // ä¾‹å¦‚ï¼šweb ä¾èµ– sharedï¼Œæ‰€ä»¥å…ˆæ„å»º shared

      "inputs": ["$TURBO_DEFAULT$", ".env*"],
      // å“ªäº›æ–‡ä»¶å˜åŒ–ä¼šè§¦å‘é‡æ–°æ„å»º
      // $TURBO_DEFAULT$ï¼šé»˜è®¤çš„æ–‡ä»¶ï¼ˆsrc/**ï¼Œpackage.json ç­‰ï¼‰
      // .env*ï¼šç¯å¢ƒå˜é‡æ–‡ä»¶

      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
      // æ„å»ºäº§ç‰©çš„ä½ç½®
      // !.next/cache/** è¡¨ç¤ºæ’é™¤ç¼“å­˜ç›®å½•
    },

    "dev": {
      "cache": false,
      // å¼€å‘æ¨¡å¼ä¸ç¼“å­˜ï¼ˆå› ä¸ºæ˜¯æŒç»­è¿è¡Œçš„ï¼‰

      "persistent": true
      // æŒä¹…ä»»åŠ¡ï¼Œä¸ä¼šè‡ªåŠ¨ç»“æŸ
    },

    "lint": {
      "dependsOn": ["^build"],
      // lint ä¹‹å‰å…ˆç¡®ä¿ä¾èµ–åŒ…å·²æ„å»º

      "cache": true
      // å¯ä»¥ç¼“å­˜ lint ç»“æœ
    },

    "test": {
      "dependsOn": ["^build"],
      "cache": true
    },

    "clean": {
      "cache": false
      // æ¸…ç†ä»»åŠ¡ä¸ç¼“å­˜
    }
  }
}
```

### 3.2 å…³é”®é…ç½®é¡¹è§£é‡Š

#### dependsOn çš„ä¸¤ç§å†™æ³•

```json
{
  "build": {
    "dependsOn": ["^build"]    // ^ç¬¦å·ï¼šå…ˆæ„å»ºä¾èµ–çš„åŒ…
  },
  "test": {
    "dependsOn": ["build"]     // æ— ^ç¬¦å·ï¼šå…ˆè¿è¡ŒåŒåŒ…çš„ build
  },
  "deploy": {
    "dependsOn": ["build", "test"]  // å¤šä¸ªä¾èµ–
  }
}
```

#### inputs å’Œ outputs

```json
{
  "build": {
    "inputs": [
      "src/**",           // æºä»£ç 
      "package.json",     // ä¾èµ–å˜åŒ–
      "tsconfig.json"     // é…ç½®å˜åŒ–
    ],
    "outputs": [
      "dist/**"           // è¾“å‡ºç›®å½•
    ]
  }
}
```

**åŸç†**ï¼šTurborepo è®¡ç®— inputs çš„å“ˆå¸Œå€¼ï¼Œå¦‚æœæ²¡å˜å°±ç›´æ¥ç”¨ç¼“å­˜çš„ outputsã€‚

---

## 4. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

### 4.1 åŸºç¡€å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰åŒ…çš„ build ä»»åŠ¡
pnpm build
# ç­‰åŒäº turbo build

# è¿è¡Œæ‰€æœ‰åŒ…çš„ dev ä»»åŠ¡ï¼ˆå¹¶è¡Œï¼‰
pnpm dev

# è¿è¡ŒæŒ‡å®šä»»åŠ¡
turbo lint
turbo test
```

### 4.2 è¿‡æ»¤å‘½ä»¤

```bash
# åªæ„å»º web åŒ…åŠå…¶ä¾èµ–
turbo build --filter=web

# åªæ„å»º web åŒ…ï¼ˆä¸å«ä¾èµ–ï¼‰
turbo build --filter=web --only

# åªæ„å»ºæ”¹åŠ¨è¿‡çš„åŒ…
turbo build --filter=[HEAD^1]

# æ„å»º apps ç›®å½•ä¸‹çš„æ‰€æœ‰åŒ…
turbo build --filter=./apps/*
```

### 4.3 è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹ä»»åŠ¡ä¾èµ–å›¾
turbo build --graph

# ç”Ÿæˆä¾èµ–å›¾æ–‡ä»¶
turbo build --graph=graph.png

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
turbo build --verbosity=2

# å¼ºåˆ¶é‡æ–°è¿è¡Œï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
turbo build --force
```

---

## 5. å¸¸è§åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1ï¼šæ—¥å¸¸å¼€å‘

```bash
# å¯åŠ¨æ‰€æœ‰åº”ç”¨çš„å¼€å‘æœåŠ¡å™¨
pnpm dev

# è¾“å‡ºï¼š
# web:dev: â–² Next.js 15.1.0
# web:dev: - Local: http://localhost:3000
# api:dev: ğŸš€ API server running on http://localhost:4000
```

### åœºæ™¯ 2ï¼šæäº¤å‰æ£€æŸ¥

```bash
# è¿è¡Œ lint å’Œ test
pnpm lint && pnpm test

# Turborepo ä¼šå¹¶è¡Œè¿è¡Œï¼Œå¹¶ä½¿ç”¨ç¼“å­˜
```

### åœºæ™¯ 3ï¼šåªæ„å»ºæ”¹åŠ¨çš„åŒ…

```bash
# åªæ„å»ºç›¸å¯¹äº main åˆ†æ”¯æœ‰æ”¹åŠ¨çš„åŒ…
turbo build --filter=[origin/main]
```

### åœºæ™¯ 4ï¼šæŸ¥çœ‹ä¸ºä»€ä¹ˆæ²¡æœ‰å‘½ä¸­ç¼“å­˜

```bash
turbo build --summarize

# ä¼šç”Ÿæˆ .turbo/runs/<run-id>.json
# åŒ…å«æ¯ä¸ªä»»åŠ¡çš„ inputs å“ˆå¸Œ
```

---

## 6. ç¼“å­˜æœºåˆ¶è¯¦è§£

### 6.1 æœ¬åœ°ç¼“å­˜

é»˜è®¤å­˜å‚¨åœ¨ `node_modules/.cache/turbo`ï¼š

```
.turbo/
â””â”€â”€ cache/
    â”œâ”€â”€ abc123.tar.zst    # web:build çš„ç¼“å­˜
    â””â”€â”€ def456.tar.zst    # api:build çš„ç¼“å­˜
```

### 6.2 ç¼“å­˜å‘½ä¸­æ¡ä»¶

ä»¥ä¸‹ä»»æ„ä¸€é¡¹å˜åŒ–éƒ½ä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼š
1. æºä»£ç å˜åŒ–ï¼ˆinputsï¼‰
2. ä¾èµ–ç‰ˆæœ¬å˜åŒ–
3. ç¯å¢ƒå˜é‡å˜åŒ–
4. ä¾èµ–çš„åŒ…çš„è¾“å‡ºå˜åŒ–

### 6.3 è¿œç¨‹ç¼“å­˜ï¼ˆå›¢é˜Ÿå…±äº«ï¼‰

```bash
# ç™»å½• Vercelï¼ˆTurborepo å®˜æ–¹ï¼‰
turbo login

# é“¾æ¥åˆ°è¿œç¨‹ç¼“å­˜
turbo link
```

**æ•ˆæœ**ï¼šé˜Ÿå‹ A æ„å»ºè¿‡çš„åŒ…ï¼Œé˜Ÿå‹ B å¯ä»¥ç›´æ¥ç”¨ç¼“å­˜ã€‚

---

## 7. å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ

### âŒ é™·é˜± 1ï¼šoutputs é…ç½®é”™è¯¯

```json
// é”™è¯¯ï¼šæ²¡æœ‰é…ç½® outputs
{
  "build": {
    "dependsOn": ["^build"]
    // ç¼ºå°‘ outputsï¼Œç¼“å­˜ä¸ä¼šä¿å­˜æ„å»ºäº§ç‰©
  }
}

// æ­£ç¡®ï¼š
{
  "build": {
    "dependsOn": ["^build"],
    "outputs": ["dist/**"]
  }
}
```

### âŒ é™·é˜± 2ï¼šç¯å¢ƒå˜é‡å¯¼è‡´ç¼“å­˜å¤±æ•ˆ

```json
// é—®é¢˜ï¼šæ¯æ¬¡ CI çš„ BUILD_ID ä¸åŒï¼Œç¼“å­˜æ°¸è¿œä¸å‘½ä¸­
{
  "build": {
    "env": ["BUILD_ID"]  // ä¸è¦åŒ…å«é¢‘ç¹å˜åŒ–çš„å˜é‡
  }
}

// è§£å†³ï¼šåªåŒ…å«å½±å“æ„å»ºç»“æœçš„å˜é‡
{
  "build": {
    "env": ["NODE_ENV", "API_URL"]
  }
}
```

### âŒ é™·é˜± 3ï¼šdev ä»»åŠ¡è®¾ç½®äº†ç¼“å­˜

```json
// é”™è¯¯ï¼šdev æ˜¯æŒç»­è¿è¡Œçš„ï¼Œä¸åº”è¯¥ç¼“å­˜
{
  "dev": {
    "cache": true
  }
}

// æ­£ç¡®ï¼š
{
  "dev": {
    "cache": false,
    "persistent": true
  }
}
```

### âœ… æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½® inputs**
   ```json
   {
     "lint": {
       "inputs": ["src/**/*.ts", "src/**/*.tsx", ".eslintrc*"]
     }
   }
   ```

2. **ä½¿ç”¨ --filter åŠ é€Ÿå¼€å‘**
   ```bash
   # åªè¿è¡Œå½“å‰æ”¹åŠ¨çš„åŒ…
   turbo build --filter=[HEAD^1]
   ```

3. **åœ¨ CI ä¸­ä½¿ç”¨è¿œç¨‹ç¼“å­˜**
   ```yaml
   - name: Build
     run: pnpm build
     env:
       TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
       TURBO_TEAM: ${{ vars.TURBO_TEAM }}
   ```

4. **å®šæœŸæ¸…ç†æœ¬åœ°ç¼“å­˜**
   ```bash
   rm -rf node_modules/.cache/turbo
   ```

---

## 8. ä¸å…¶ä»–å·¥å…·å¯¹æ¯”

| ç‰¹æ€§ | Turborepo | Nx | Lerna |
|------|-----------|-----|-------|
| ç¼“å­˜ | âœ… å†…ç½® | âœ… å†…ç½® | âŒ éœ€æ’ä»¶ |
| è¿œç¨‹ç¼“å­˜ | âœ… å…è´¹ | ğŸ’° ä»˜è´¹ | âŒ æ—  |
| å­¦ä¹ æ›²çº¿ | ä½ | é«˜ | ä¸­ |
| é…ç½®å¤æ‚åº¦ | ç®€å• | å¤æ‚ | ä¸­ç­‰ |
| å¢é‡æ„å»º | âœ… | âœ… | âŒ |

---

## 9. æ€»ç»“

### è®°ä½è¿™ 5 ç‚¹å°±å¤Ÿäº†

1. **turbo.json** å®šä¹‰ä»»åŠ¡å’Œä¾èµ–å…³ç³»
2. **dependsOn: ["^build"]** è¡¨ç¤ºå…ˆæ„å»ºä¾èµ–çš„åŒ…
3. **cache: true/false** æ§åˆ¶æ˜¯å¦ç¼“å­˜
4. **outputs** å‘Šè¯‰ Turbo ç¼“å­˜å“ªäº›æ–‡ä»¶
5. **--filter** ç”¨äºåªè¿è¡Œç‰¹å®šåŒ…

### Turborepo çš„æ ¸å¿ƒä»·å€¼

```
æ²¡æœ‰ Turborepoï¼špnpm build éœ€è¦ 30 ç§’
æœ‰ Turborepoï¼ˆé¦–æ¬¡ï¼‰ï¼š30 ç§’
æœ‰ Turborepoï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ï¼š0.3 ç§’ âš¡
```

**ä¸€å¥è¯æ€»ç»“**ï¼šTurborepo è®©ä½ åªæ„å»ºéœ€è¦æ„å»ºçš„ä¸œè¥¿ã€‚
