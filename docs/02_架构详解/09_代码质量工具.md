# ESLint 与 Prettier 详解

> 面向初级开发者的代码质量工具教程，遵循二八原则

## 官方资源

| 工具 | 官方文档 | 配置参考 |
|------|----------|----------|
| ESLint | [eslint.org](https://eslint.org/) | [eslint.org/docs/latest/use/configure](https://eslint.org/docs/latest/use/configure/) |
| Prettier | [prettier.io](https://prettier.io/) | [prettier.io/docs/en/options](https://prettier.io/docs/en/options.html) |
| Husky | [typicode.github.io/husky](https://typicode.github.io/husky/) | [typicode.github.io/husky/get-started](https://typicode.github.io/husky/get-started.html) |
| lint-staged | [github.com/lint-staged/lint-staged](https://github.com/lint-staged/lint-staged) | README |
| @typescript-eslint | [typescript-eslint.io](https://typescript-eslint.io/) | [typescript-eslint.io/rules](https://typescript-eslint.io/rules/) |

## 1. 为什么需要这些工具

### 问题场景

```javascript
// 团队成员 A 的代码
function hello(name){
    return "Hello, "+name
}

// 团队成员 B 的代码
const hello = (name) => {
  return `Hello, ${name}`;
};

// 团队成员 C 的代码
function hello( name ) {
  return 'Hello, ' + name;
}
```

**问题**：同一个功能，三种写法，代码风格不统一。

### 解决方案

| 工具 | 作用 | 类比 |
|------|------|------|
| **ESLint** | 检查代码质量和错误 | 语法老师 |
| **Prettier** | 统一代码格式 | 排版编辑 |
| **Husky** | Git 钩子，提交前自动检查 | 门卫 |
| **lint-staged** | 只检查改动的文件 | 快速通道 |

---

## 2. ESLint 详解

### 2.1 ESLint 是什么

ESLint 是一个**代码检查工具**，能发现：
- 语法错误
- 潜在 bug（如未使用的变量）
- 不好的写法（如 `==` 而不是 `===`）

### 2.2 ESLint 能检查什么

```javascript
// ❌ 未使用的变量
const unused = 'never used';

// ❌ 未定义的变量
console.log(notDefined);

// ❌ == 而不是 ===
if (a == b) { }

// ❌ console.log 忘记删除
console.log('debug');

// ❌ 可能的空指针
user.name.toUpperCase();  // user 可能是 null
```

### 2.3 项目中的 ESLint 配置

#### packages/eslint-config/base.js

```javascript
/** @type {import("eslint").Linter.Config} */
module.exports = {
  // 解析器：使用 TypeScript 解析器
  parser: '@typescript-eslint/parser',

  // 插件：扩展 ESLint 能力
  plugins: ['@typescript-eslint', 'import'],

  // 继承的规则集
  extends: [
    'eslint:recommended',           // ESLint 推荐规则
    'plugin:@typescript-eslint/recommended',  // TS 推荐规则
    'prettier',                      // 关闭与 Prettier 冲突的规则
  ],

  // 运行环境
  env: {
    node: true,      // Node.js 环境
    es2022: true,    // ES2022 语法
  },

  // 自定义规则
  rules: {
    // 未使用变量：警告，但忽略以 _ 开头的
    '@typescript-eslint/no-unused-vars': ['warn', { argsIgnorePattern: '^_' }],

    // any 类型：警告（不是错误）
    '@typescript-eslint/no-explicit-any': 'warn',

    // 函数返回类型：关闭（让 TS 推断）
    '@typescript-eslint/explicit-function-return-type': 'off',

    // import 排序
    'import/order': [
      'warn',
      {
        groups: ['builtin', 'external', 'internal', 'parent', 'sibling', 'index'],
        'newlines-between': 'always',  // 组之间空行
        alphabetize: { order: 'asc' }, // 字母排序
      },
    ],
  },

  // 忽略的文件
  ignorePatterns: ['node_modules/', 'dist/', '.next/', '.turbo/'],
};
```

#### packages/eslint-config/nextjs.js

```javascript
module.exports = {
  extends: [
    'next/core-web-vitals',  // Next.js 规则
    './base.js',              // 继承 base 配置
  ],
  rules: {
    '@next/next/no-html-link-for-pages': 'off',  // 允许普通 a 标签
    'react/jsx-key': 'warn',  // 列表需要 key
  },
};
```

### 2.4 规则级别

```javascript
rules: {
  'rule-name': 'off',    // 0 - 关闭
  'rule-name': 'warn',   // 1 - 警告（不阻止运行）
  'rule-name': 'error',  // 2 - 错误（阻止运行）
}
```

### 2.5 常用命令

```bash
# 检查代码
npx eslint .

# 自动修复
npx eslint . --fix

# 检查特定文件
npx eslint src/app.ts

# 只检查错误（忽略警告）
npx eslint . --quiet
```

---

## 3. Prettier 详解

### 3.1 Prettier 是什么

Prettier 是一个**代码格式化工具**，处理：
- 缩进（空格/Tab）
- 引号（单引号/双引号）
- 分号
- 换行
- 括号位置

### 3.2 Prettier vs ESLint

| 方面 | ESLint | Prettier |
|------|--------|----------|
| 关注点 | 代码质量 | 代码格式 |
| 例子 | 未使用变量、类型错误 | 缩进、引号、分号 |
| 可配置性 | 高（很多规则） | 低（故意限制选项） |

### 3.3 项目中的 Prettier 配置

#### .prettierrc

```json
{
  "semi": true,
  // 语句末尾加分号
  // true: const a = 1;
  // false: const a = 1

  "singleQuote": true,
  // 使用单引号
  // true: 'hello'
  // false: "hello"

  "tabWidth": 2,
  // 缩进宽度：2 个空格

  "trailingComma": "es5",
  // 尾逗号
  // "es5": 对象/数组末尾加逗号
  // "none": 不加
  // "all": 函数参数也加

  "printWidth": 100,
  // 每行最大字符数，超过自动换行

  "bracketSpacing": true,
  // 对象括号内加空格
  // true: { foo: bar }
  // false: {foo: bar}

  "arrowParens": "always",
  // 箭头函数参数括号
  // "always": (x) => x
  // "avoid": x => x

  "endOfLine": "lf",
  // 换行符：LF（Unix）

  "plugins": ["prettier-plugin-tailwindcss"]
  // 插件：自动排序 Tailwind 类名
}
```

#### .prettierignore

```
node_modules
.next
dist
.turbo
coverage
pnpm-lock.yaml
```

### 3.4 常用命令

```bash
# 格式化所有文件
npx prettier --write .

# 检查格式（不修改）
npx prettier --check .

# 格式化特定文件
npx prettier --write src/app.ts

# 格式化特定类型
npx prettier --write "**/*.{ts,tsx}"
```

---

## 4. ESLint + Prettier 协作

### 4.1 为什么需要协作

```
ESLint 规则：使用双引号
Prettier 规则：使用单引号
→ 冲突！ESLint 刚改完，Prettier 又改回来
```

### 4.2 解决方案：eslint-config-prettier

```javascript
// eslint 配置中添加
extends: [
  'eslint:recommended',
  'prettier',  // 放在最后！关闭 ESLint 中与 Prettier 冲突的规则
],
```

### 4.3 推荐工作流

```
1. Prettier 负责格式
2. ESLint 负责质量
3. eslint-config-prettier 解决冲突
```

---

## 5. Husky 详解

### 5.1 Husky 是什么

Husky 让你在 **Git 操作时自动运行脚本**，比如：
- 提交前检查代码
- 推送前运行测试

### 5.2 Git Hooks 介绍

| Hook | 触发时机 | 常见用途 |
|------|----------|----------|
| `pre-commit` | commit 之前 | 代码检查、格式化 |
| `commit-msg` | 填写 commit 信息后 | 检查提交信息格式 |
| `pre-push` | push 之前 | 运行测试 |

### 5.3 项目中的配置

#### .husky/pre-commit

```bash
pnpm lint-staged
```

每次 `git commit` 前自动运行 `lint-staged`。

### 5.4 安装与配置

```bash
# 安装
pnpm add -D husky

# 初始化
pnpm exec husky init

# 这会创建 .husky 目录和 pre-commit 文件
```

---

## 6. lint-staged 详解

### 6.1 lint-staged 是什么

只对**暂存区（staged）的文件**运行检查，而不是整个项目。

### 6.2 为什么需要

```bash
# 没有 lint-staged
git commit  →  检查 1000 个文件  →  等待 30 秒

# 有 lint-staged
git commit  →  只检查你改的 3 个文件  →  1 秒搞定
```

### 6.3 项目中的配置

#### .lintstagedrc.js

```javascript
module.exports = {
  // TypeScript/JavaScript 文件
  '*.{ts,tsx}': ['eslint --fix', 'prettier --write'],
  // 1. 先用 ESLint 修复
  // 2. 再用 Prettier 格式化

  // JavaScript 文件
  '*.{js,jsx}': ['eslint --fix', 'prettier --write'],

  // 其他文件
  '*.{json,md,yaml,yml}': ['prettier --write'],

  // CSS 文件
  '*.css': ['prettier --write'],
};
```

### 6.4 工作流程

```
git add file.ts
     ↓
git commit -m "feat: xxx"
     ↓
Husky 触发 pre-commit hook
     ↓
运行 lint-staged
     ↓
lint-staged 找到 staged 的 file.ts
     ↓
运行 eslint --fix file.ts
     ↓
运行 prettier --write file.ts
     ↓
如果没有错误，提交成功
如果有错误，提交失败
```

---

## 7. 完整工作流演示

### 7.1 日常开发

```bash
# 1. 写代码
# 2. 保存时 VS Code 自动格式化（配置 Prettier 插件）
# 3. 准备提交
git add .
git commit -m "feat: add user login"

# 自动发生：
# → Husky 触发 pre-commit
# → lint-staged 运行
# → ESLint 检查
# → Prettier 格式化
# → 通过则提交，失败则终止
```

### 7.2 检查失败示例

```bash
git commit -m "feat: add login"

# 输出：
✖ eslint --fix:
  /src/login.ts
    3:7  error  'password' is defined but never used  @typescript-eslint/no-unused-vars

# 提交被阻止，需要修复后重新提交
```

### 7.3 手动运行检查

```bash
# 检查整个项目
pnpm lint

# 格式化整个项目
pnpm format

# 只检查不修复
pnpm format:check
```

---

## 8. VS Code 配置推荐

### 8.1 必装插件

- **ESLint**：实时显示 ESLint 错误
- **Prettier**：格式化支持
- **Tailwind CSS IntelliSense**：Tailwind 类名补全

### 8.2 settings.json 配置

```json
{
  // 保存时自动格式化
  "editor.formatOnSave": true,

  // 默认格式化器
  "editor.defaultFormatter": "esbenp.prettier-vscode",

  // TypeScript 文件使用 Prettier
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },

  // 保存时运行 ESLint 修复
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": "explicit"
  },

  // ESLint 验证的语言
  "eslint.validate": [
    "javascript",
    "javascriptreact",
    "typescript",
    "typescriptreact"
  ]
}
```

---

## 9. 常见问题与解决

### ❌ 问题 1：ESLint 和 Prettier 冲突

```
ESLint: Replace `"hello"` with `'hello'`
Prettier: Replace `'hello'` with `"hello"`
```

**解决**：确保 ESLint 配置中 extends 最后是 `'prettier'`

```javascript
extends: [
  'eslint:recommended',
  'prettier',  // 必须放最后
],
```

### ❌ 问题 2：Husky 不生效

```bash
# 检查是否安装
ls .husky

# 重新初始化
pnpm exec husky init

# 确保 package.json 有 prepare 脚本
{
  "scripts": {
    "prepare": "husky"
  }
}
```

### ❌ 问题 3：lint-staged 太慢

```javascript
// 减少检查范围
module.exports = {
  '*.{ts,tsx}': ['eslint --fix --max-warnings=0'],
  // 移除 prettier，让 VS Code 保存时处理
};
```

### ❌ 问题 4：想跳过检查

```bash
# 紧急情况跳过（不推荐）
git commit -m "fix: urgent" --no-verify
```

---

## 10. 常见陷阱与最佳实践

### ❌ 陷阱 1：规则太严格

```javascript
// 错误：所有都设为 error
rules: {
  '@typescript-eslint/no-explicit-any': 'error',  // 可能阻碍开发
}

// 推荐：渐进式
rules: {
  '@typescript-eslint/no-explicit-any': 'warn',  // 先警告
}
```

### ❌ 陷阱 2：忽略 ESLint 警告

```typescript
// eslint-disable-next-line @typescript-eslint/no-explicit-any
const data: any = fetchData();  // ❌ 滥用 disable

// 正确做法：修复类型
const data: UserData = fetchData();  // ✅
```

### ✅ 最佳实践

1. **团队统一配置**
   - 把配置放在 `packages/eslint-config`
   - 所有项目继承

2. **渐进式引入**
   - 新项目：严格规则
   - 老项目：先 warn 再逐步 error

3. **自动化**
   - VS Code 保存时格式化
   - Git 提交时检查
   - CI 中再次验证

4. **保持简单**
   - 不要加太多规则
   - 用社区推荐配置

---

## 11. 总结

### 工具分工

```
你写代码
    ↓
VS Code + Prettier → 自动格式化
    ↓
VS Code + ESLint → 实时提示错误
    ↓
git commit
    ↓
Husky → 触发 pre-commit
    ↓
lint-staged → 只检查改动文件
    ↓
ESLint + Prettier → 最终检查
    ↓
通过 → 提交成功
失败 → 修复后重试
```

### 记住这 5 点

1. **Prettier 管格式**：缩进、引号、分号
2. **ESLint 管质量**：未使用变量、类型错误
3. **Husky 管钩子**：提交前自动检查
4. **lint-staged 提速度**：只检查改动文件
5. **eslint-config-prettier 解冲突**：让两者和平共处

### 核心价值

```
没有这些工具：代码风格混乱，bug 上线才发现
有了这些工具：代码整洁统一，问题提交前就解决
```

**一句话总结**：这套工具让代码质量在提交前就有保障。
